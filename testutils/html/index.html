<!DOCTYPE html>
<html lang="en">
<head>

    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">


    <!-- Meta -->
    <meta name="description" content="Testing">
    <meta name="author" content="Fasten Health">

    <title>Testing</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css" integrity="sha384-xOolHFLEh07PJGoPkLv1IbcEPTNtaed2xpHsD9ESMhqIYd0nLMwNLD69Npy4HI+N" crossorigin="anonymous">
    <style>
        p {
            text-align: justify;
        }

        .cursor-pointer {
            cursor: pointer;
            color: blue;

        }
        a:hover {
            text-decoration: underline;
        }


        ul {
            display: grid;
            grid-template-columns: repeat(3, auto);
            justify-content: space-around;
            gap: 0 3em;
        }

        .jumbotron {
            padding-top: 1rem;
            padding-bottom: 1rem;
            margin-bottom: 0;
            background-color: #fff;
        }
        @media (min-width: 768px) {
            .jumbotron {
                padding-top: 2rem;
                padding-bottom: 2rem;
            }
        }

        .jumbotron p:last-child {
            margin-bottom: 0;
        }

        .jumbotron h1 {
            font-weight: 300;
        }

        /*.jumbotron .container {*/
        /*    max-width: 40rem;*/
        /*}*/

        footer {
            padding-top: 3rem;
            padding-bottom: 3rem;
        }

        footer p {
            margin-bottom: .25rem;
        }

    </style>
</head>
<body class="az-body">
    <main role="main">
        <section class="jumbotron text-center">
            <div class="container">
                <h1>Fasten Lighthouse Sources</h1>
                <p class="lead text-muted">There are 2 flavors of Fasten:</p>
                <ul>
                    <li><strong>Sandbox</strong>  only allows you to connect to a handful of Healthcare providers, using Sandbox accounts that are meant for testing</li>
                    <li><strong>Prod</strong>  allow you to connect and retrieve your personal electronic medical record and store it within Fasten. Be careful, this is YOUR health data</li>
                </ul>



                <div class="btn-group btn-group-toggle" data-toggle="buttons">
                    <label class="btn btn-outline-primary active">
                        <input type="radio" class="btn-check" name="source_mode" id="sandbox" autocomplete="off" value="sandbox" checked>
                        Sandbox Providers
                    </label>
                    <label class="btn btn-outline-secondary">
                        <input type="radio" class="btn-check" name="source_mode" id="prod" value="prod" autocomplete="off">
                        Production Providers
                    </label>
                </div>
            </div>
        </section>

<!--        START - Source Search -->
        <div class="album py-5 bg-light">
            <div class="container">
                <div class="row">
                    <div class="col-12">
                        <div id="sourceTotal" class="alert alert-warning" role="alert"></div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-12">
                        <div class="form-group row">
                            <label for="sourceNameSearch" class="col-sm-2 col-form-label">Source Name</label>
                            <div class="col-sm-10">
                                <input type="text" class="form-control" id="sourceNameSearch">
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-12">

                        <div id="sourceSpinner" class="spinner-border" role="status">
                            <span class="sr-only">Loading...</span>
                        </div>
                        <ul id="sourceList" class="list-unstyled row">
                            <li class="list-item">An item</li>
                            <li class="list-group-item">A second item</li>
                            <li class="list-group-item">A third item</li>
                        </ul>

                    </div>
                </div>
            </div>
        </div>
<!--        END - Source Search-->

<!--        START - CUSTOM SOURCE-->
        <div class="container">
            <div class="row">
                <div class="col-12">
                    <div class="accordion" id="accordionExample">
                        <div class="card">
                            <div class="card-header" id="headingOne">
                                <h2 class="mb-0">
                                    <button class="btn btn-link btn-block text-left" type="button" data-toggle="collapse" data-target="#collapseOne" aria-expanded="true" aria-controls="collapseOne">
                                        Define Custom Source
                                    </button>
                                </h2>
                            </div>

                            <div id="collapseOne" class="collapse" aria-labelledby="headingOne" data-parent="#accordionExample">
                                <div class="card-body">
                                    <div class="form-group">
                                        <label for="customSourceType">Source Type</label>
                                        <input required type="text" class="form-control auto-save" id="customSourceType" placeholder="epic,cerner,etc">
                                    </div>
                                    <div class="form-group">
                                        <label for="customAuthEndpoint">Authorization Endpoint</label>
                                        <input required type="text" class="form-control" id="customAuthEndpoint" placeholder="https://www.example.com/oauth/oauth2/authorize">
                                    </div>
                                    <div class="form-group">
                                        <label for="customTokenEndpoint">Token Endpoint</label>
                                        <input required type="text" class="form-control" id="customTokenEndpoint" placeholder="https://www.example.com/oauth/oauth2/token">
                                    </div>
                                    <div class="form-group">
                                        <label for="customApiEndpointBaseUrl">Api Endpoint Base Url</label>
                                        <input required type="text" class="form-control" id="customApiEndpointBaseUrl" placeholder="https://www.example.com/r4/fhir">
                                    </div>
                                    <div class="form-group">
                                        <label for="customResponseMode">Response Mode</label>
                                        <select required class="form-control" id="customResponseMode">
                                            <option>fragment</option>
                                            <option>query</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label for="customClientId">Client ID</label>
                                        <input required type="text" class="form-control" id="customClientId" placeholder="xxx-xxx-xxx">
                                    </div>
                                    <div class="form-group">
                                        <label for="customScopes">Scopes</label>
                                        <select required multiple class="form-control" id="customScopes">
                                            <optgroup>
                                                <option selected>fhirUser</option>
                                                <option selected>openid</option>
                                                <option selected>profile</option>
                                                <option>offline</option>
                                                <option>offline_access</option>
                                                <option>launch/patient</option>
                                            </optgroup>
                                            <optgroup>
                                                <option>patient/*.read</option>
                                                <option>patient/*</option>
                                                <option>patient/*.*</option>
                                            </optgroup>
                                            <optgroup>
                                                <option>patient/Account.read</option>
                                                <option>patient/AllergyIntolerance.read</option>
                                                <option>patient/Appointment.read</option>
                                                <option>patient/Binary.read</option>
                                                <option>patient/CarePlan.read</option>
                                                <option>patient/CareTeam.read</option>
                                                <option>patient/ChargeItem.read</option>
                                                <option>patient/Communication.read</option>
                                                <option>patient/Condition.read</option>
                                                <option>patient/Consent.read</option>
                                                <option>patient/Coverage.read</option>
                                                <option>patient/Device.read</option>
                                                <option>patient/DiagnosticReport.read</option>
                                                <option>patient/DocumentReference.read</option>
                                                <option>patient/Encounter.read</option>
                                                <option>patient/FamilyMemberHistory.read</option>
                                                <option>patient/Goal.read</option>
                                                <option>patient/Immunization.read</option>
                                                <option>patient/InsurancePlan.read</option>
                                                <option>patient/MedicationAdministration.read</option>
                                                <option>patient/MedicationRequest.read</option>
                                                <option>patient/NutritionOrder.read</option>
                                                <option>patient/Observation.read</option>
                                                <option>patient/Patient.read</option>
                                                <option>patient/Person.read</option>
                                                <option>patient/Procedure.read</option>
                                                <option>patient/Provenance.read</option>
                                                <option>patient/Questionnaire.read</option>
                                                <option>patient/QuestionnaireResponse.read</option>
                                                <option>patient/RelatedPerson.read</option>
                                                <option>patient/Schedule.read</option>
                                                <option>patient/ServiceRequest.read</option>
                                                <option>patient/Slot.read</option>
                                                <option>system/Appointment.read</option>
                                            </optgroup>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label for="customAudience">Audience</label>
                                        <input type="text" class="form-control" id="customAudience" placeholder="(optional)">
                                    </div>

                                    <div class="form-group form-check">
                                        <input type="checkbox" class="form-check-input" id="customConfidential">
                                        <label class="form-check-label" for="customConfidential">Confidential <small style="color:red;">requires coordination with support@fastenhealth.com</small></label>
                                    </div>

                                    <button id="customSourceSubmit" type="button" class="btn btn-primary btn-sm mb-3">Submit</button>

                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

<!--        END - CUSTOM SOURCE-->
    </main>

    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-Fy6S3B9q64WdZWQUiU+q4/2Lc9npb8tCaSX9FK7E8HnRr0Jz8D6OP9dO5Vg3Q9ct" crossorigin="anonymous"></script>
    <script type="module" src="https://cdnjs.cloudflare.com/ajax/libs/oauth4webapi/2.0.6/index.js"></script>
    <!--<script src="https://unpkg.com/infinite-scroll@4/dist/infinite-scroll.pkgd.min.js"></script>-->
    <script type="module">
        import * as Oauth from 'https://cdnjs.cloudflare.com/ajax/libs/oauth4webapi/2.0.6/index.js'

        //GLOBAL variables
        var CURRENT_FILTER = newMedicalSourcesFilter()

        var SOURCE_ENDPOINT_LOOKUP = {
            "sandbox": "https://lighthouse.fastenhealth.com/sandbox/",
            "prod": "https://lighthouse.fastenhealth.com/v1/"
        }


        function defineCustomSource(){
            var lighthouseEndpoint = SOURCE_ENDPOINT_LOOKUP[$('input[name="source_mode"]:checked').val()]

            let api_endpoint_base_url = $('#customApiEndpointBaseUrl').val()
            //if api_endpoint_base_url ends with "/" character, trim
            if (api_endpoint_base_url[api_endpoint_base_url.length - 1] === "/") {
                api_endpoint_base_url = api_endpoint_base_url.slice(0, -1)
            }


            var sourceType = $('#customSourceType').val()
            var customSource = {
                custom_source: true,

                authorization_endpoint: $('#customAuthEndpoint').val(),
                token_endpoint: $('#customTokenEndpoint').val(),
                redirect_uri: `${lighthouseEndpoint}callback/${sourceType}`,
                response_types_supported: ['code'],
                response_modes_supported: [$('#customResponseMode').val()],
                aud: $('#customAudience').val(),
                issuer: api_endpoint_base_url,
                api_endpoint_base_url: api_endpoint_base_url,
                confidential: $('#customConfidential').is(":checked"),
                code_challenge_methods_supported: ['S256'],
                client_id: $('#customClientId').val(),
                scopes_supported: $('#customScopes').val(),

            }
            console.log(customSource)

            generateSourceAuthorizeUrl(sourceType, customSource)
        }

        function requestSourceList(filter){
            var sourceList = $('#sourceList')
            sourceList.html("")

            var lighthouseEndpoint = SOURCE_ENDPOINT_LOOKUP[$('input[name="source_mode"]:checked').val()]
            localStorage.setItem('lighthouseEndpoint', lighthouseEndpoint)


            showSpinner()
            $.post(  lighthouseEndpoint + 'search', JSON.stringify(filter), function( response ) {
                console.log(response.data)
                for(const source of response.data.hits.hits){
                    var li = $('<li/>')
                        .addClass("list-item")
                        .addClass("col-4")
                        .appendTo(sourceList);
                    $('<a/>')
                        .text(source._source.display)
                        .addClass("cursor-pointer")
                        .on('click', function() {
                            //disable everything
                            showSpinner()

                            //get the full source information and generate the authorization url
                            $.get(  lighthouseEndpoint + 'connect/' + source._id, function( response ) {
                                console.log(response.data)
                                generateSourceAuthorizeUrl(source._id, response.data)
                            });
                        })
                        .appendTo(li);

                    $('#sourceTotal').html(response.data.hits.total.value + " sources found. Showing page 1.")
                }
                hideSpinner()
            });
        }

        function showSpinner(){
            $('#sourceSpinner').show()
            $('#sourceList').hide()
            $('#sourceTotal').hide()
        }
        function hideSpinner(){
            $('#sourceSpinner').hide()
            $('#sourceList').show()
            $('#sourceTotal').show()
        }

        async function  generateSourceAuthorizeUrl(sourceType, lighthouseSource){
            const state = 'custom'
            let sourceStateInfo = {}
            sourceStateInfo.state = state
            sourceStateInfo.source_type = sourceType

            // generate the authorization url
            const authorizationUrl = new URL(lighthouseSource.authorization_endpoint);
            authorizationUrl.searchParams.set('redirect_uri', lighthouseSource.redirect_uri);
            authorizationUrl.searchParams.set('response_type', lighthouseSource.response_types_supported[0]);
            authorizationUrl.searchParams.set('response_mode', lighthouseSource.response_modes_supported[0]);
            authorizationUrl.searchParams.set('state', state);
            authorizationUrl.searchParams.set('client_id', lighthouseSource.client_id);
            if(lighthouseSource.scopes_supported && lighthouseSource.scopes_supported.length){
                authorizationUrl.searchParams.set('scope', lighthouseSource.scopes_supported.join(' '));
            }
            if (lighthouseSource.aud) {
                authorizationUrl.searchParams.set('aud', lighthouseSource.aud);
            }

            //this is for providers that support CORS and PKCE (public client auth)
            if(!lighthouseSource.confidential){
                // https://github.com/panva/oauth4webapi/blob/8eba19eac408bdec5c1fe8abac2710c50bfadcc3/examples/public.ts
                const codeVerifier = Oauth.generateRandomCodeVerifier();
                const codeChallenge = await Oauth.calculatePKCECodeChallenge(codeVerifier);
                const codeChallengeMethod = lighthouseSource.code_challenge_methods_supported[0]; // 'S256'

                sourceStateInfo.code_verifier = codeVerifier
                sourceStateInfo.code_challenge = codeChallenge
                sourceStateInfo.code_challenge_method = codeChallengeMethod

                authorizationUrl.searchParams.set('code_challenge', codeChallenge);
                authorizationUrl.searchParams.set('code_challenge_method', codeChallengeMethod);
            }

            localStorage.setItem(state, JSON.stringify(sourceStateInfo))
            localStorage.setItem("clientId", lighthouseSource.client_id)

            if(lighthouseSource.custom_source){
                //this isn't actually a lighthouse retrieved source, this is a custom defined source
                // we need to store this configuration in local storage so we can use it later
                localStorage.setItem(`${state}.customSource`, JSON.stringify(lighthouseSource))
            }

            redirectWithOriginAndDestination(authorizationUrl, sourceType, lighthouseSource.redirect_uri);
        }

        function redirectWithOriginAndDestination(destUrl, sourceType, callbackUri) {
            const originUrlParts = new URL(window.location.href)
            originUrlParts.hash = "" //reset hash in-case its present.
            originUrlParts.pathname = originUrlParts.pathname + `/callback/${sourceType}`


            const redirectUrlParts = new URL(callbackUri.replace("/callback/", "/redirect/"));
            const redirectParams = new URLSearchParams()
            redirectParams.set("origin_url", originUrlParts.toString())
            redirectParams.set("dest_url", destUrl)
            redirectUrlParts.search = redirectParams.toString()
            console.log(redirectUrlParts.toString());

            // Simulate a mouse click:
            window.location.href = redirectUrlParts.toString();
        }

        function newMedicalSourcesFilter(){
            let filter = {}
            filter.fields = ["*"];
            // filter.searchAfter = '';

            return filter
        }


        //autosave and reload custom source form
        // function persist(event) {
        //     localStorage.setItem(event.target.id, event.target.value);
        // }
        //
        // // you may use a more specific selector;
        // document.querySelectorAll(".form-control.auto-save").forEach((inputEl) => {
        //     inputEl.value = localStorage.getItem(inputEl.id);
        //     inputEl.addEventListener("change", persist);
        // });

        $(function() {

            //search depends on 2 things
            //the source_mode and the search field

            $('input[name="source_mode"]').change(function() {
                $('#sourceNameSearch').val('') //reset text search
                requestSourceList(CURRENT_FILTER)
                //store the source_mode id in localStorage
                var sourceMode = $('input[name="source_mode"]:checked').val()
                localStorage.setItem('sourceMode', sourceMode)
            });

            $('#sourceNameSearch').on("change paste keyup", function() {
                CURRENT_FILTER.query = $(this).val()
                requestSourceList(CURRENT_FILTER)
            });

            $('#customSourceSubmit').click(function() {
                defineCustomSource()
            });

            // on startup, populate the table with sources
            requestSourceList(newMedicalSourcesFilter());
        });
    </script>
</body>
</html>
