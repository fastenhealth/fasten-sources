<!DOCTYPE html>
<html lang="en" xmlns:x-bind="http://www.w3.org/1999/xhtml">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, shrink-to-fit=no"
    />

    <!-- Meta -->
    <meta name="description" content="Testing" />
    <meta name="author" content="Fasten Health" />

    <title>Testing</title>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css"
      integrity="sha384-xOolHFLEh07PJGoPkLv1IbcEPTNtaed2xpHsD9ESMhqIYd0nLMwNLD69Npy4HI+N"
      crossorigin="anonymous"
    />
    <style>
      pre {
        white-space: pre-wrap; /* css-3 */
        white-space: -moz-pre-wrap; /* Mozilla, since 1999 */
        white-space: -pre-wrap; /* Opera 4-6 */
        white-space: -o-pre-wrap; /* Opera 7 */
        word-wrap: break-word; /* Internet Explorer 5.5+ */
      }

      .jumbotron {
        padding-top: 1rem;
        padding-bottom: 1rem;
        margin-bottom: 0;
        background-color: #fff;
      }
      @media (min-width: 768px) {
        .jumbotron {
          padding-top: 2rem;
          padding-bottom: 2rem;
        }
      }

      .jumbotron p:last-child {
        margin-bottom: 0;
      }

      .jumbotron h1 {
        font-weight: 300;
      }

      /*.jumbotron .container {*/
      /*    max-width: 40rem;*/
      /*}*/

      footer {
        padding-top: 3rem;
        padding-bottom: 3rem;
      }

      footer p {
        margin-bottom: 0.25rem;
      }
    </style>
  </head>
  <body class="az-body">
    <main role="main" x-data="pageCallbackData()" x-init="callbackInit()">
      <section class="jumbotron text-center">
        <div class="container">
          <h1>Fasten Lighthouse Callback Data</h1>
          <p class="lead text-muted">
            This placeholder <strong>callback</strong> page is used to complete
            the OAuth flow, <br />
            exchanging the <strong>authorization code</strong> for an
            <strong>access token</strong>
          </p>
        </div>
      </section>

      <div class="bg-light">
        <div class="container">
          <div class="row">
            <div class="col-12">
              <div x-show="!!oauth_error.error" class="alert alert-danger">
                <strong x-text="oauth_error.error"></strong>
                <span
                  class="ml-1"
                  x-text="oauth_error.error_description"
                ></span>
              </div>

              <div class="accordion" id="accordionExample">
                <div class="card">
                  <div class="card-header" id="headingState">
                    <h2 class="mb-0">
                      <button
                        class="btn btn-link btn-block text-left"
                        type="button"
                        data-toggle="collapse"
                        data-target="#collapseState"
                        aria-expanded="true"
                        aria-controls="collapseState"
                      >
                        State Information
                      </button>
                    </h2>
                  </div>

                  <div
                    id="collapseState"
                    class="collapse show"
                    aria-labelledby="headingState"
                    data-parent="#accordionExample"
                  >
                    <div class="card-body">
                      <pre x-text="state_info"></pre>
                    </div>
                  </div>
                </div>
                <div class="card">
                  <div class="card-header" id="headingOne">
                    <h2 class="mb-0">
                      <button
                        class="btn btn-link btn-block text-left"
                        type="button"
                        data-toggle="collapse"
                        data-target="#collapseOne"
                        aria-expanded="true"
                        aria-controls="collapseOne"
                      >
                        Authorization Code
                      </button>
                    </h2>
                  </div>

                  <div
                    id="collapseOne"
                    class="collapse show"
                    aria-labelledby="headingOne"
                    data-parent="#accordionExample"
                  >
                    <div class="card-body">
                      <pre x-text="callback_code"></pre>
                    </div>
                  </div>
                </div>
                <div class="card">
                  <div class="card-header" id="headingTwo">
                    <h2 class="mb-0">
                      <button
                        class="btn btn-link btn-block text-left collapsed"
                        type="button"
                        data-toggle="collapse"
                        data-target="#collapseTwo"
                        aria-expanded="false"
                        aria-controls="collapseTwo"
                      >
                        Access Token Exchange Response
                      </button>
                    </h2>
                  </div>
                  <div
                    id="collapseTwo"
                    class="collapse"
                    aria-labelledby="headingTwo"
                    data-parent="#accordionExample"
                  >
                    <div class="card-body">
                      <pre x-text="oauth_data"></pre>
                    </div>
                  </div>
                </div>

                <div id="cardJWT" class="card">
                  <div class="card-header" id="headingJWT">
                    <h2 class="mb-0">
                      <button
                        class="btn btn-link btn-block text-left collapsed"
                        type="button"
                        data-toggle="collapse"
                        data-target="#collapseJWT"
                        aria-expanded="false"
                        aria-controls="collapseJWT"
                      >
                        Access Token JWT
                      </button>
                    </h2>
                  </div>
                  <div
                    id="collapseJWT"
                    class="collapse"
                    aria-labelledby="headingJWT"
                    data-parent="#accordionExample"
                  >
                    <div class="card-body">
                      <pre x-text="jwt_data"></pre>
                    </div>
                  </div>
                </div>
                <div id="cardIdJWT" class="card">
                  <div class="card-header" id="headingIdJWT">
                    <h2 class="mb-0">
                      <button
                        class="btn btn-link btn-block text-left collapsed"
                        type="button"
                        data-toggle="collapse"
                        data-target="#collapseIdJWT"
                        aria-expanded="false"
                        aria-controls="collapseIdJWT"
                      >
                        Id Token JWT
                      </button>
                    </h2>
                  </div>
                  <div
                    id="collapseIdJWT"
                    class="collapse"
                    aria-labelledby="headingIdJWT"
                    data-parent="#accordionExample"
                  >
                    <div class="card-body">
                      <pre x-text="id_jwt_data"></pre>
                    </div>
                  </div>
                </div>

                <div class="card">
                  <div class="card-header" id="headingThree">
                    <h2 class="mb-0">
                      <button
                        class="btn btn-link btn-block text-left collapsed"
                        type="button"
                        data-toggle="collapse"
                        data-target="#collapseThree"
                        aria-expanded="false"
                        aria-controls="collapseThree"
                      >
                        Patient ID
                      </button>
                    </h2>
                  </div>
                  <div
                    id="collapseThree"
                    class="collapse"
                    aria-labelledby="headingThree"
                    data-parent="#accordionExample"
                  >
                    <div class="card-body">
                      <pre id="patient_id"></pre>
                      <button
                        @click="populatePatientHandler()"
                        x-bind:disabled="loadingPatient"
                        type="button"
                        class="btn btn-primary btn-sm mb-3"
                      >
                        Request
                      </button>
                      <pre
                        style="max-height: 400px"
                        x-text="patient_data"
                        x-show="!loadingPatient"
                      ></pre>
                    </div>
                  </div>
                </div>

                <div class="card">
                  <div class="card-header" id="headingRaw">
                    <h2 class="mb-0">
                      <button
                        class="btn btn-link btn-block text-left collapsed"
                        type="button"
                        data-toggle="collapse"
                        data-target="#collapseRaw"
                        aria-expanded="false"
                        aria-controls="collapseRaw"
                      >
                        Authenticated Raw Request
                      </button>
                    </h2>
                  </div>
                  <div
                    id="collapseRaw"
                    class="collapse"
                    aria-labelledby="headingRaw"
                    data-parent="#accordionExample"
                  >
                    <div class="card-body">
                      <div class="form-group">
                        <label for="rawResourceType">Resource Type</label>
                        <input
                          type="text"
                          placeholder="Observation,Patient,etc"
                          class="form-control"
                          id="rawResourceType"
                          x-model="raw_resource_type"
                          aria-describedby="emailHelp"
                        />
                      </div>
                      <div class="form-group">
                        <label for="rawResourcePath">Resource Path</label>
                        <input
                          type="text"
                          class="form-control"
                          id="rawResourcePath"
                          x-model="raw_resource_path"
                        />
                      </div>

                      <button
                        @click="rawPatientRequestHandler()"
                        type="button"
                        x-bind:disabled="loadingRawRequest"
                        class="btn btn-primary btn-sm mb-3"
                      >
                        Submit Request
                      </button>
                      <pre
                        style="max-height: 400px"
                        x-show="!loadingRawRequest"
                        x-text="raw_data"
                      ></pre>
                      <div
                        x-show="!loadingRawRequest && !!raw_data_error"
                        class="alert alert-danger"
                        role="alert"
                        x-text="raw_data_error"
                      ></div>
                    </div>
                  </div>
                </div>

                <div class="card">
                  <div class="card-header" id="headingSyncAll">
                    <h2 class="mb-0">
                      <button
                        class="btn btn-link btn-block text-left collapsed"
                        type="button"
                        data-toggle="collapse"
                        data-target="#collapseSyncAll"
                        aria-expanded="false"
                        aria-controls="collapseSyncAll"
                      >
                        SyncAll Request
                      </button>
                    </h2>
                  </div>
                  <div
                    id="collapseSyncAll"
                    class="collapse"
                    aria-labelledby="headingSyncAll"
                    data-parent="#accordionExample"
                  >
                    <div class="card-body">
                      <button
                        @click="syncAllRequestHandler()"
                        type="button"
                        x-bind:disabled="loadingSyncAllRequest"
                        class="btn btn-primary btn-sm mb-3"
                      >
                        Submit SyncAll Request
                      </button>

                      <ol x-show="!loadingSyncAllRequest && !!totalSynced">
                        <li>Elapsed: <span x-text="elapsedTime"></span></li>
                        <li>
                          Total Synced: <span x-text="totalSynced"></span>
                        </li>
                      </ol>
                      <pre
                        style="max-height: 400px"
                        x-show="!loadingSyncAllRequest"
                        x-text="sync_all_data"
                      ></pre>
                      <hr />
                      <pre
                        style="max-height: 400px"
                        x-show="!loadingSyncAllRequest"
                        x-text="errorData"
                      ></pre>

                      <div
                        x-show="!loadingSyncAllRequest && !!sync_all_data_error"
                        class="alert alert-danger"
                        role="alert"
                        x-text="sync_all_data_error"
                      ></div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <!--        <div class="az-error-wrapper">-->
      <!--            <h2>Source Callback Data</h2>-->

      <!--            <ul>-->
      <!--&lt;!&ndash;                <li>Callback code: <pre id="callback_code"></pre></li>&ndash;&gt;-->
      <!--&lt;!&ndash;                <li>OAuth data: <pre id="oauth_data"></pre></li>&ndash;&gt;-->
      <!--&lt;!&ndash;                <li>Patient id: <pre id="patient_data"></pre></li>&ndash;&gt;-->
      <!--            </ul>-->

      <!--        </div>-->
    </main>

    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-Fy6S3B9q64WdZWQUiU+q4/2Lc9npb8tCaSX9FK7E8HnRr0Jz8D6OP9dO5Vg3Q9ct"
      crossorigin="anonymous"
    ></script>
    <script
      type="module"
      src="https://cdnjs.cloudflare.com/ajax/libs/oauth4webapi/2.0.6/index.js"
    ></script>
    <script type="module">
      import alpinejs from "https://cdn.skypack.dev/alpinejs@v3.13.4";
      import * as Oauth from "https://cdnjs.cloudflare.com/ajax/libs/oauth4webapi/2.0.6/index.js";
      alpinejs.data("pageCallbackData", pageCallbackData);
      alpinejs.start();

      export function pageCallbackData() {
        return {
          endpoint_id: "",

          state_info: "",
          callback_code: "",
          oauth_data: "",
          accessToken: "",
          refreshToken: "",
          expiresIn: "",
          jwt_data: "",
          id_jwt_data: "",
          patient_id: "",
          oauth_error: {
            error: "",
            error_description: "",
          },

          sourceDefinition: {},

          loadingPatient: false,
          patient_data: "",

          loadingRawRequest: false,
          raw_resource_type: "",
          raw_resource_path: "",
          raw_data: "",
          raw_data_error: "",

          loadingSyncAllRequest: false,
          sync_all_data: "",
          elapsedTime: "",
          totalSynced: 0,
          errorData: "",

          callbackInit() {
            //get sourceType from url (example.com/callback/{{sourceType}})
            var parts = window.location.pathname.split("/");

            const callbackUrlParts = new URL(window.location.href);
            const fragmentParams = new URLSearchParams(
              callbackUrlParts.hash.substring(1)
            );
            const callbackState =
              callbackUrlParts.searchParams.get("state") ||
              fragmentParams.get("state");

            const sourceStateInfoJson = localStorage.getItem(callbackState);
            const sourceStateInfo = JSON.parse(sourceStateInfoJson);
            this.state_info = JSON.stringify(sourceStateInfo, null, 4);
            this.endpoint_id = sourceStateInfo.endpoint_id;

            //check if localstorage has a customDefinition for this state
            if (
              callbackState &&
              localStorage.getItem(`${callbackState}.customDefinition`)
            ) {
              console.log("using custom definition for this state");
              this.sourceDefinition = JSON.parse(
                localStorage.getItem(`${callbackState}.customDefinition`)
              );
              localStorage.removeItem(`${callbackState}.customDefinition`);
              this.processCallbackUsingLighthouseSource(this.sourceDefinition)
                .then(console.log)
                .catch(console.error);
            } else {
              throw new Error(
                "No custom definition found for this state, this should never happen"
              );
            }
          },
          async processCallbackUsingLighthouseSource(sourceDefinition) {
            //get required parameters from the URI and local storage
            const callbackUrlParts = new URL(window.location.href);
            const fragmentParams = new URLSearchParams(
              callbackUrlParts.hash.substring(1)
            );
            const callbackCode =
              callbackUrlParts.searchParams.get("code") ||
              fragmentParams.get("code");
            const callbackState =
              callbackUrlParts.searchParams.get("state") ||
              fragmentParams.get("state");
            const callbackError =
              callbackUrlParts.searchParams.get("error") ||
              fragmentParams.get("error");
            const callbackErrorDescription =
              callbackUrlParts.searchParams.get("error_description") ||
              fragmentParams.get("error_description");

            const expectedSourceStateInfo = JSON.parse(
              localStorage.getItem(callbackState)
            );
            localStorage.removeItem(callbackState);

            if (callbackError && !callbackCode) {
              //TOOD: print this message in the UI
              let errMsg =
                "an error occurred while authenticating to this source. Please try again later";
              console.error(errMsg, callbackErrorDescription);
              this.oauth_error.error = callbackError;
              this.oauth_error.error_description = callbackErrorDescription;

              throw new Error(errMsg);
            }

            console.log("callback code:", callbackCode);
            this.callback_code = callbackCode;

            let payload = await this.swapOauthToken(
              sourceDefinition,
              expectedSourceStateInfo,
              callbackCode
            );
            this.oauth_data = JSON.stringify(payload, null, 4);
            this.accessToken = payload.access_token;
            this.expiresIn = payload.expires_in;
            this.refreshToken = payload.refresh_token;

            //check if the access token is a JWT
            if (payload.access_token.split(".").length === 3) {
              //if it is, decode it and print it
              this.jwt_data = JSON.stringify(
                JSON.parse(
                  atob(
                    payload.access_token
                      .split(".")[1]
                      .replace(/-/g, "+")
                      .replace(/_/g, "/")
                  )
                ),
                null,
                4
              );
            }

            //check if theres an id token, and its a jwt
            if (payload.id_token && payload.id_token.split(".").length === 3) {
              //if it is, decode it and print it
              this.id_jwt_data = JSON.stringify(
                JSON.parse(
                  atob(
                    payload.id_token
                      .split(".")[1]
                      .replace(/-/g, "+")
                      .replace(/_/g, "/")
                  )
                ),
                null,
                4
              );
            }

            this.patient_id = payload.patient;
          },

          async swapOauthToken(
            sourceDefinition,
            expectedSourceStateInfo,
            code
          ) {
            // @ts-expect-error
            const client = {
              client_id: sourceDefinition.client_id,
            };
            //this is for providers that support CORS & PKCE (public client auth)
            let codeVerifier = undefined;

            let tokenEndpointUrl = sourceDefinition.token_endpoint;

            if (sourceDefinition.confidential) {
              console.log(
                "This is a confidential client, using lighthouse token endpoint."
              );
              //if this is a confidential client, we need to "override" token endpoint, and use the Fasten Lighthouse to complete the swap
              let lighthouse_api_endpoint_base =
                sourceDefinition.redirect_uri.split("/callback/");

              let endpoint_id = expectedSourceStateInfo.endpoint_id;
              if (sourceDefinition.confidential_endpoint) {
                endpoint_id = sourceDefinition.confidential_endpoint;
              }

              tokenEndpointUrl = this.pathJoin([
                lighthouse_api_endpoint_base[0],
                `token/${endpoint_id}`,
              ]);

              //use a placeholder client_secret (the actual secret is stored in Lighthouse)
              client.client_secret = "placeholder";
              client.token_endpoint_auth_method = "client_secret_basic";
              if (
                (sourceDefinition.code_challenge_methods_supported || [])
                  .length > 0
              ) {
                codeVerifier = expectedSourceStateInfo.code_verifier;
              } else {
                codeVerifier = "placeholder";
              }
            } else {
              console.log(
                "This is a public client, using source token endpoint."
              );
              client.token_endpoint_auth_method = "none";
              codeVerifier = expectedSourceStateInfo.code_verifier;

              if (sourceDefinition.cors_relay_required) {
                console.error(
                  "This is a public client, but requires a CORS relay."
                );
                //check if source requires a CORS relay
                const originUrlParts = new URL(window.location.href);

                let corsProxyBaseUrl = `http://${originUrlParts.host}/api/source/cors/`;

                //this endpoint requires a CORS relay
                //get the path to the Fasten server, and append `cors/` and then append the request url
                let tokenEndpointUrlParts = new URL(tokenEndpointUrl);
                tokenEndpointUrl =
                  corsProxyBaseUrl +
                  `${tokenEndpointUrlParts.hostname}${tokenEndpointUrlParts.pathname}${tokenEndpointUrlParts.search}`;
                console.warn(
                  "Using local CORS proxy for token endpoint",
                  tokenEndpointUrl
                );
              }
            }

            const as = {
              issuer: sourceDefinition.issuer,
              authorization_endpoint: sourceDefinition.authorization_endpoint,
              token_endpoint: tokenEndpointUrl,
              introspection_endpoint: sourceDefinition.introspection_endpoint,
            };

            console.log("STARTING--- Oauth.validateAuthResponse", as);
            const params = Oauth.validateAuthResponse(
              as,
              client,
              new URLSearchParams({
                code: code,
                state: expectedSourceStateInfo.state,
              }),
              expectedSourceStateInfo.state
            );
            if (Oauth.isOAuth2Error(params)) {
              console.log("error", params);
              throw new Error(
                "error when validating code & state before token exchange"
              ); // Handle OAuth 2.0 redirect error
            }
            console.log("ENDING--- Oauth.validateAuthResponse");
            console.log(
              "STARTING--- Oauth.authorizationCodeGrantRequest",
              sourceDefinition.redirect_uri,
              params,
              codeVerifier
            );
            const response = await Oauth.authorizationCodeGrantRequest(
              as,
              client,
              params,
              sourceDefinition.redirect_uri,
              codeVerifier
            );
            let payload = await response.json();
            console.log(
              "ENDING--- Oauth.authorizationCodeGrantRequest",
              payload
            );
            return payload;
          },
          sourceRequest(resourceType, resourceRequest) {
            let payload = {
              sourceDefinition: this.sourceDefinition,
              requestData: {
                resourceType: resourceType,
                resourceRequest: resourceRequest,
                accessToken: this.accessToken,
                refreshToken: this.refreshToken,
                expiresIn: this.expiresIn,
              },
            };

            //post JSON payload to /api/source/request using fetch

            return fetch("/api/source/request", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify(payload),
            })
              .then((resp) => resp.json())
              .catch((error) => {
                console.error("Error:", error);
                return error.responseText;
              });
          },
          sourceSyncAllRequest() {
            let payload = {
              sourceDefinition: this.sourceDefinition,
              requestData: {
                accessToken: this.accessToken,
                refreshToken: this.refreshToken,
                expiresIn: this.expiresIn,
                patientId: this.patient_id,
              },
            };

            //post JSON payload to /api/source/request using fetch

            return fetch("/api/source/syncall", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify(payload),
            })
              .then((resp) => resp.json())
              .catch((error) => {
                console.error("Error:", error);
                return error.responseText;
              });
          },

          //Click handlers
          populatePatientHandler() {
            this.loadingPatient = true;

            this.patient_data = "Loading...";
            this.sourceRequest("Patient", this.patient_id).then((resp) => {
              console.log("Patient data", resp);
              this.patient_data = JSON.stringify(resp, null, 4);
              this.loadingPatient = false;
            });
          },
          rawPatientRequestHandler() {
            this.loadingRawRequest = true;
            this.raw_data = "Loading...";
            this.raw_data_error = "";

            this.sourceRequest(this.raw_resource_type, this.raw_resource_path)
              .then((resp) => {
                console.log("Raw Request data", resp);
                this.raw_data = JSON.stringify(resp, null, 4);
                this.loadingRawRequest = false;
              })
              .catch((e) => {
                this.raw_data = "";
                this.raw_data_error = e.toString();
                this.loadingRawRequest = false;
              });
          },
          syncAllRequestHandler() {
            this.loadingSyncAllRequest = true;
            this.sync_all_data = "Loading...";
            this.elapsedTime = "";
            this.totalSynced = "";
            this.errorData = "";

            this.sync_all_data_error = "";

            this.sourceSyncAllRequest()
              .then((resp) => {
                console.log("SyncAll Request data", resp);
                this.elapsedTime = resp["elapsed"];
                this.totalSynced = resp["total_records"];
                this.errorData = JSON.stringify(resp["errors"], null, 4);
                this.sync_all_data = resp.data;
                this.loadingSyncAllRequest = false;
              })
              .catch((e) => {
                this.sync_all_data = "";
                this.sync_all_data_error = e.toString();
                this.loadingSyncAllRequest = false;
              });
          },

          //helpers

          pathJoin(parts, sep) {
            const separator = sep || "/";
            parts = parts.map((part, index) => {
              if (index) {
                part = part.replace(new RegExp("^" + separator), "");
              }
              if (index !== parts.length - 1) {
                part = part.replace(new RegExp(separator + "$"), "");
              }
              return part;
            });
            return parts.join(separator);
          },
        };
      }
    </script>
  </body>
</html>
